# Why CDK(Cloud Development Kit)?



## What is CDK?

CDK 이전에는 CloudFormation을 사용했는데 CloudFormation은 선언형 개발도구다. json이나 yaml 파일에 설정 값을 줘서 인프라를 구성한다. 반면에 명령형 개발도구다. AWS CDK(Cloud Development Kit)는 프로그래밍 언어를 사용하여 클라우드 애플리케이션 리소스를 모델링 및 프로비저닝 해주는 도구다. AWS CDK를 사용하면 인프라를 코드로 정의하고 AWS CloudFormation을 통해 프로비저닝할 수 있다.

TS, Python, .Net, Java 언어 등을 지원하고 있다. 코드로 인프라를 작성할 수 있기 때문에 보다 개발자 친화적이다. CDK로 작성한 코드는 CloudFromation 템플릿으로 변환되고 이를 통해 리소스가 생성된다.



## 인프라 관리 불편 사례

### 사례1: 업데이트 되어 UI 스타일이 바뀐 관리 콘솔 화면

문제 : GUI가 일반인들에게 친숙하긴 하지만, 전문가에게는 CLI가 오히려 더 편리하다. 또한 GUI를 토대로 매뉴얼 문서를 작성했다가 UI가 변경이 되면 문서의 사진들을 다시 캡쳐해서 업데이트 해줘야 한다.

해결 : 당연하지만, cdk를 이용하면 Management Console의 UI가 달라져도 아무 영향이 없다. UI는 달라질 가능성이 있지만, aws-cdk의 인터페이스는 거의 변경되지 않는다. 설령 변경되더라도 하위 호환이 유지될 것이고, 안 되면 코드를 조금 수정하면 된다.



### 사례2: 정리되지 않은 리소스로 인해 예상치 않은 비용 청구

문제 : 인프라 리소스에는 계층이 있고 의존 관계가 있다. 예를 들면, VPC를 만들고, 보안 그룹을 만들고, 서브넷을 만들고, EC2 인스턴스를 만들고 서로 연결했다고 하자. 나중에 VPC 단위로 리소스를 삭제하려면 어떻게 해야할까? 의존 관계에 따라 생성의 역순으로 삭제해야 한다. (분해는 조립의 역순) 만약 이것저것 여기저기 따로 만들었으면 삭제가 쉽지 않다. 이런 맥락이 어딘가에 일목요연하게 설계도처럼 정리되어 있으면 관리하기도 쉽고 생성/삭제도 어렵지 않을 것이다.

> 리소스의 계층과 의존 관계가 정리된 설계도를 AWS에서는 스택(Stack)이라고 한다.

해결 : CDK를 이용해서 스택 단위로 인프라를 생성하고, 이용이 끝나면 다시 스택 단위로 말끔히 제거하기 때문에 실수로 남은 리소스 때문에 요금이 발생하는 불상사를 막을 수 있다.



### 사례3: 중구난방 어수선한 인프라 관리

문제 : 인프라 관리 업무를 인수인계 받았는데, 무엇이 있고 서로가 어떤 관계를 가지고 있는지 파악하기가 어렵다. 하지만 이러한 의존성을 하나의 파일이나 소스 코드로 관리를 했다면 인수인계가 훨씬 수월하고 인프라 설계가 어떻게 되었는지 한 눈에 파악할 수 있을 것이다. 거시적 관점으로 인프라를 관리를 비유한 [DevOps Concepts: Pets vs Cattle](https://medium.com/@Joachim8675309/devops-concepts-pets-vs-cattle-2380b5aab313)을 읽어보라. 우리는 GUI로 수작업을 하는 것을 벗어나야 한다. 동시에 파일 하나로 모든 설정을 관리할 수 있다면 CLI를 통해서 설정하는 것도 벗어나야 한다. 소스 코드 패키지를 하나 작성하고 명령어 한 줄로 모든 설정을 하면 되니깐 말이다.

해결 : 이미 존재하는 리소스에 그때그때 임의로 변경을 가하면 어떤 변경이 있었는지, 현재 상태가 어떠한지 추적하기가 힘들다. 대신 인프라 스택을 표현한 소스코드를 만들어두고, 인프라를 변경할 때 해당 소스코드를 바탕으로 애플리케이션을 배포하듯이 변경을 적용하면, 인프라의 변경 이력과 현재 상태를 쉽게 추적할 수 있다. 즉 소스코드 버전 관리 시스템과 같은 방식으로 인프라를 관리할 수 있게 된다.



### 사례4: 인프라의 재구성

문제 : 프리티어를 사용하면서 개인 블로그를 운영하고 있는데, 1년이 다 되어서 새롭게 계정을 파야 한다. 하지만 여태까지 구성한 모든 인프라를 수작업으로 일일이 다 하자니 막막하다. 만약 CDK를 이용해서 파일로 관리를 했다면 aws account와 region 값만 변경하면 바로 인프라를 구성할 수 있다.

해결 : aws-cdk를 이용해 인프라 프로비저닝을 할 수 있다. (사실 사례2와 같은 내용이니, 철거도 쉽습니다.) 프리티어 만료 시에 새 프리티어 계정을 만들어서 프리티어를 유지하고 싶다면, cdk 스택에서 AWS Account 환경변수만 바꿔주면 된다. (단, DB 데이터 같은 건 마이그레이션 해야한다.)



## aws-cdk를 사용했을 때 좋은점은?

aws-cdk는 내부적으로 CLI와 AWS CloudFormation을 사용한다. 이 두가지 서비스를 코드로 작성해서 편리하게 이용할 수 있도록 해주는 것이다.

CloudFormation의 요소인 스택의 특성은 다음과 같다.

- 스택(Stack) 단위로 인프라를 생성/업데이트/삭제한다. (스택 수준의 원자성)
- 스택은 다른 스택을 포함할 수 있다. (계층 구조)

스택을 이용하여 인프라를 생성/업데이트/삭제하는 일련의 과정을 하나의 논리 집합으로 표현할 수 있다.



CDK는 프로그래밍 언어 계층에서 접근할 수 있으므로 사용 편의성과 생산성이 극대화된다.

- 코드 인라인 설명, 리팩토링 도구, 코드 탐색 및 단위 테스트 같은 기존 IDE 기능들 역시 모두 동일하게 작동하므로 관리 및 개발이 더 수월해진다. (특히, typescript 에서 작업하는 경우 정말 훌륭한 개발경험을 선사한다.)
- 기존에 사용하던 형상 관리 툴을 그대로 사용하면 되니, 버전을 관리하기도 편리하다. 동시에, 함께 개발하는 팀원과 쉽게 공유할 수 있다.
- 반복, 분기 등 프로그래밍 언어가 가지는 특성을 그대로 인프라 구성 설정에 반영할 수 있다.
- 익숙한 코드로 AWS 인프라를 구성할 수 있기 때문에 코드를 읽으면 인프라가 어떻게, 어떤 방식으로 구성되어 있는지 확인할 수도 있다.
- VSCode 사용자의 경우, 인프라의 스택, 리소스 및 정책 등의 정보를 편하게 볼 수 있도록 하는 “AWS Toolkit” Extesion을 제공한다.



## CDK 구성요소

### App

앱은 기본 구문이며, CDK CLI를 통해 AWS CloudFormation 템플릿을 렌더링하고 배포한다. 그리고 배포 가능한 단위인 하나 이상의 스택으로 구성되며 리전 및 계정에 대한 정보를 포함한다.

### Stack

배포의 한 부분을 stack이라고 한다. Stacke의 scope 안에서 정의된 모든 AWS 리소스는 single unit으로 프로비저닝된다. AWS CDK 앱에서 스택 수를 원하는 만큼 정의할 수 있다. 스택 구조의 모든 인스턴스는 스택을 나타낸다.

### Construct(구문)

Construct는 AWS CDK 앱의 기본 구성 요소이다. Construct는 "클라우드 구성 요소"를 나타내며 AWS CloudFormation이 구성 요소를 만드는 데 필요한 모든 것을 캡슐화한다.

Construct는 Amazon S3(Amazon Simple Storage Service) 버킷과 같은 단일 AWS 리소스를 나타낼 수도 있고 여러 AWS 관련 리소스로 구성된 상위 수준의 추상화일 수도 있다.

즉 App은 여러 개의 Stacke 인스턴스를 생성하고 Stack은 여러 개의 Construct(AWS 리소스)로 이루어져 있다.



## Reference

* CDK API Reference : https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html
* CDK Example : https://github.com/aws-samples/aws-cdk-examples
