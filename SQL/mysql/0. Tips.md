# Tips

## Mysql DB 생성 및 사용자 권한 부여

```sh
$ mysql -uroot -p
Enter password: <pssword input>

> create database <db_name>;
> use <db_name>;
> grant all privileges on <db_name>.* to '<user_name>'@'localhost';
```

## 명령어

```sh
# 디비 조회
show databases;
```

## 호스트 컴퓨터에서 도커 container mysql 접속

단순하게 -P 옵션으로 port를 지정해준다고 하더라도 컨테이너 쪽 mysql 에 접속할 수 없습니다.  

**정확히 말하면, 우리가 원하는 포트가 아니라 3306 기본 포트로만 접속되게 됩니다.** 

그 이유는 mysql에서 hostname을 명시하지 않거나 localhost로 지정해서 접속하게 되면, 조금은 특별한 방식으로 처리되기 때문입니다.

자세한 내용은 **[mysql 공식문서](https://dev.mysql.com/doc/refman/5.7/en/connecting.html)**, **[stackoverflow 답변](https://stackoverflow.com/questions/50160128/why-wont-mysql-client-use-the-port-i-specify)** 을 참조하시면 되지만,
요약하자면 localhost에 대한 연결의 경우 MySQL 프로그램은 **유닉스 소켓 파일을 사용**하여 로컬 서버에 연결을 시도합니다.
즉, 우리가 원하는 대로 **127.0.0.1에 TCP/IP로 연결하는 것이 아니라는 뜻**입니다. 

이를 해결하고자 한다면 2가지 방법이 있습니다. 

------

#### **1. mysql hostname 지정**

호스트는 따로 지정하지 않으면 localhost이며, 이렇게 되면 유닉스 소켓파일을 사용하여 연결시도를 한다고 했습니다.

바꿔 말하면 127.0.0.1 과 같이 지정 해 준다면, 우리가 원하는 TCP 방식으로 연결을 한다는 뜻입니다.

```bash
mysql -h 127.0.0.1 -u root -p -P 3307
```

이제 정상적으로 컨테이너 내부의 mysql에 접속할 수 있습니다.

## DB Dump

### Dump dev db

만약 mysql 8버전을 사용한다면 brew 명령어도 mysql 8 버전을 사용해야 한다. 그 후 디비 덤프를 뜬다.

1. `brew install mysql@8.0`
2. `echo 'export PATH="/opt/homebrew/Cellar/mysql@8.0/8.0.39_5/bin:$PATH"' >> ~/.zshrc`
3. `source ~/.zshrc`
4. `mysqldump --default-auth=mysql_native_password -u <user> -p -h <host> <database> > cookiedeal_dev.sql`

헌데 로컬에다가 write를 하는게 아니라 RDS에다가 덤프 뜬 파일을 Write를 하고 싶다면 `mysqldump` 명령을 칠 때 미리 `--set-gtid-purged=OFF` 를 넣어줘야 한다.

```bash
mysqldump --set-gtid-purged=OFF -u <user> -p -h <host> <database> > cookiedeal_dev.sql
```

Ref : https://sonnson.tistory.com/15

### Restore dump file to local db

1. Install docker and docker-compose
2. Execute `docker-compose up`
3. If you use dbeaver, you have to check `allowPublicKeyRetrieval = true`
   <img width="804" alt="image" src="https://github.com/user-attachments/assets/a2d05442-6e7d-4f74-a7ff-caa6f01db581">
4. `mysql -h 127.0.0.1 -u root -p -P 3307 cookiedeal < cookiedeal_dev.sql`

로컬 디비가 아닌 RDS에다가 하고 싶다면 테라폼 설정에서 parameter에 `log_bin_trust_function_creators` = 1로 설정해줘야 한다.

```yaml
resource "aws_db_parameter_group" "rds-mysql8" {
  /*
    log_bin_trust_function_creators 파라미터를 1로 설정하는 것은 다음과 같은 의미를 갖습니다:
    1. 기능: 이 설정을 1(ON)로 하면, 사용자가 SUPER 권한 없이도 저장 함수나 트리거를 생성할 수 있게 됩니다.
    2. 보안 완화: 기본적으로 이 값은 0(OFF)으로 설정되어 있어, 바이너리 로깅이 활성화된 상태에서 함수나 트리거 생성 시 보안 제한이 있습니다. 1로 설정하면 이러한 제한이 완화됩니다2.
    3. 함수 생성 조건 완화:
      - 기본적으로 함수는 DETERMINISTIC, NO SQL, 또는 READS SQL DATA로 선언되어야 합니다.
      - 이 설정을 1로 하면 이러한 조건 없이도 함수를 생성할 수 있습니다2.
    4. 바이너리 로깅 관련: 바이너리 로깅이 활성화된 상태에서 특정 작업을 수행할 때 발생하는 제한을 완화합니다12.
    5. 적용 방식: apply_method = "immediate"는 이 설정이 즉시 적용됨을 의미합니다. 데이터베이스 재시작 없이 바로 적용됩니다3.
    6. 주의사항: 이 설정을 1로 하면 보안상 덜 안전할 수 있으므로, 프로덕션 환경에서는 신중히 적용해야 합니다2.
  */
  parameter {
    apply_method = "immediate"
    name         = "log_bin_trust_function_creators"
    value        = "1"
  }
}
```



## RO 계정 발급

## 🔐 MySQL 기준

### 1. 운영 DB 접속

```bash
mysql -h your-db-endpoint.rds.amazonaws.com -u admin_user -p
```

### 2. 사용자 생성

```sql
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'strong_password';
```

> `%`는 모든 IP에서 접근을 허용합니다. 보안을 위해 특정 IP로 제한하는 것이 좋습니다.

예시:

```sql
CREATE USER 'readonly_user'@'192.168.0.10' IDENTIFIED BY 'strong_password';
```

### 3. SELECT 권한 부여

```sql
GRANT SELECT ON your_database_name.* TO 'readonly_user'@'%';
```

또는 전체 데이터베이스에 대해서는:

```sql
GRANT SELECT ON *.* TO 'readonly_user'@'%';
```

### 4. 권한 적용

```sql
FLUSH PRIVILEGES;
```

### 5. 테스트

```bash
mysql -h your-db-endpoint.rds.amazonaws.com -u readonly_user -p
```

- SELECT는 가능해야 하고,
- INSERT, UPDATE 등은 권한 오류가 발생해야 합니다.

---

## 🐘 PostgreSQL 기준

```sql
CREATE USER readonly_user WITH PASSWORD 'strong_password';
GRANT CONNECT ON DATABASE your_database TO readonly_user;
GRANT USAGE ON SCHEMA public TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- 앞으로 생성되는 테이블에 대해서도 SELECT 권한 자동 부여
ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO readonly_user;
```

---

## 🔐 보안 팁

- 강력한 비밀번호 사용
- 보안 그룹에서 접근 가능한 IP 제한
- 필요 시 IAM 인증 또는 AWS Secrets Manager 연동 고려

---

## 🔄 `FLUSH PRIVILEGES;`란?

MySQL에서 권한 변경 사항을 반영하기 위해 사용하는 명령어입니다.

### ✅ 정의

`FLUSH PRIVILEGES;`는 MySQL 서버에게 **"권한 관련 시스템 테이블을 다시 로드하라"**는 명령입니다.  
이는 시스템 테이블(`mysql.user`, `mysql.db` 등)을 직접 수정했을 때 변경 사항을 적용하기 위해 사용됩니다.

### ✅ 언제 필요한가?

| 사용 예시                                                | 설명                                    | `FLUSH PRIVILEGES;` 필요 여부 |
| -------------------------------------------------------- | --------------------------------------- | ----------------------------- |
| `GRANT`, `REVOKE`, `CREATE USER`, `DROP USER`            | MySQL의 공식 권한 명령어 사용           | ❌ 필요 없음 (자동 적용됨)     |
| `UPDATE mysql.user SET ...` 같은 시스템 테이블 직접 수정 | 권한 관련 테이블을 수동으로 수정한 경우 | ✅ 필요함                      |

### 📌 예시

```sql
-- 시스템 테이블 직접 수정 (비추천)
UPDATE mysql.user SET Host='%' WHERE User='readonly_user';

-- 변경 사항 적용
FLUSH PRIVILEGES;
```

### 📝 요약

- 일반적인 권한 부여 명령어(`GRANT`, `REVOKE`)를 사용할 때는 `FLUSH PRIVILEGES`가 **필요하지 않습니다.**
- 시스템 권한 테이블을 직접 수정한 경우에만 `FLUSH PRIVILEGES;`를 **명시적으로 실행해야 합니다.**
